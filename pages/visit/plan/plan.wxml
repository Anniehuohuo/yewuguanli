<!-- pages/visit/plan/plan.wxml -->
<view class="container">
  <!-- æ—¥æœŸç­›é€‰æ  -->
  <view class="date-filter-section">
    <view class="date-filter-header">
      <text class="filter-title">ğŸ“… æ‹œè®¿è®¡åˆ’</text>
      <view class="filter-actions">
        <picker mode="date" value="{{selectedDate}}" bindchange="onDatePickerChange">
          <view class="filter-btn">
            <text class="filter-date">{{selectedDateDisplay || 'é€‰æ‹©æ—¥æœŸ'}}</text>
            <text class="filter-arrow">â–¼</text>
          </view>
        </picker>
        <view class="filter-clear" wx:if="{{selectedDate}}" bindtap="clearDateFilter">
          <text class="clear-icon">âœ•</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«æ·æ—¥æœŸé€‰æ‹© -->
    <view class="quick-date-tabs">
      <view class="date-tab {{currentDateTab === 'today' ? 'active' : ''}}" bindtap="selectQuickDate" data-type="today">
        ä»Šå¤©
      </view>
      <view class="date-tab {{currentDateTab === 'tomorrow' ? 'active' : ''}}" bindtap="selectQuickDate" data-type="tomorrow">
        æ˜å¤©
      </view>
      <view class="date-tab {{currentDateTab === 'week' ? 'active' : ''}}" bindtap="selectQuickDate" data-type="week">
        æœ¬å‘¨
      </view>
      <view class="date-tab {{currentDateTab === 'all' ? 'active' : ''}}" bindtap="selectQuickDate" data-type="all">
        å…¨éƒ¨
      </view>
    </view>
    
    <!-- ç­›é€‰ç»“æœç»Ÿè®¡ -->
    <view class="filter-stats" wx:if="{{filteredPlans.length > 0 || selectedDate}}">
      <text class="stats-text">å…±æ‰¾åˆ° {{filteredPlans.length}} æ¡è®¡åˆ’</text>
      <text class="stats-date" wx:if="{{selectedDateDisplay}}">ï¼ˆ{{selectedDateDisplay}}ï¼‰</text>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <!-- <view class="search-section">
    <view class="search-bar">
      <input class="search-input" placeholder="æœç´¢å®¢æˆ·æˆ–å¤‡æ³¨" value="{{searchKeyword}}" bindinput="onSearchInput" />
      <view class="search-icon">ğŸ”</view>
    </view>
  </view> -->

  <!-- è®¡åˆ’åˆ—è¡¨ -->
  <view class="plan-list" wx:if="{{filteredPlans.length > 0}}">
    <view class="plan-card" wx:for="{{filteredPlans}}" wx:key="id" bindtap="viewPlanDetail" data-id="{{item.id}}">
      <view class="card-header">
        <view class="customer-section">
          <view class="customer-avatar">{{item.customerName.charAt(0)}}</view>
          <view class="customer-info">
            <view class="customer-name-row">
              <text class="customer-name">{{item.customerName}}</text>
              <text class="visit-tag" wx:if="{{item.isNearbyVisit}}">é¡ºè®¿</text>
            </view>
            <view class="plan-time">ğŸ“… {{item.planDate}} {{item.planTime}}</view>
            <view class="route-order" wx:if="{{item.routeOrder}}">ğŸ—ºï¸ ç¬¬{{item.routeOrder}}ç«™</view>
          </view>
        </view>
        <view class="priority-badge priority-{{item.priority}}">{{item.priority === 'high' ? 'é«˜' : item.priority === 'low' ? 'ä½' : 'æ™®é€š'}}</view>
      </view>
      
      <view class="card-content" wx:if="{{item.remark}}">
        <view class="plan-remark">ğŸ’¬ {{item.remark}}</view>
      </view>
      
      <view class="card-footer">
        <view class="status-section">
          <view class="status-badge status-{{item.status}}">
            <text wx:if="{{item.status === 'pending'}}">â³ å¾…æ‰§è¡Œ</text>
            <text wx:elif="{{item.status === 'completed'}}">âœ… å·²å®Œæˆ</text>
            <text wx:else>âŒ å·²å–æ¶ˆ</text>
          </view>
        </view>
        <view class="action-section">
          <view class="action-btn call-btn" catchtap="callCustomer" data-phone="{{item.customerPhone}}" wx:if="{{item.customerPhone}}">
            ğŸ“
          </view>
          <view class="action-btn start-btn" catchtap="startVisit" data-id="{{item.id}}" wx:if="{{item.status === 'pending'}}">
            ğŸš€ å¼€å§‹
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-title">æš‚æ— æ‹œè®¿è®¡åˆ’</view>
    <view class="empty-desc">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ æ‹œè®¿è®¡åˆ’</view>
  </view>

  <!-- æ‚¬æµ®æŒ‰é’®ç»„ -->
  <view class="fab-group">
    <!-- è·¯å¾„è§„åˆ’æŒ‰é’® -->
    <view class="fab-btn fab-route" bindtap="optimizeRoute">
      <text class="fab-icon">ğŸ—ºï¸</text>
    </view>
    <!-- æ·»åŠ è®¡åˆ’æŒ‰é’® -->
    <view class="fab-btn fab-add" bindtap="showAddPlan">
      <text class="fab-icon">+</text>
    </view>
  </view>

  <!-- æ·»åŠ è®¡åˆ’å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="hideAddModal">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ æ‹œè®¿è®¡åˆ’</text>
        <view class="modal-close" bindtap="hideAddModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- å®¢æˆ·é€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">é€‰æ‹©å®¢æˆ· *</view>
          <view class="customer-selector" bindtap="showCustomerSearch">
            <text class="selector-text" wx:if="{{newPlan.customerName}}">{{newPlan.customerName}}</text>
            <text class="selector-placeholder" wx:else>ç‚¹å‡»é€‰æ‹©å®¢æˆ·</text>
            <text class="selector-arrow">â€º</text>
          </view>
        </view>
        
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">è®¡åˆ’æ—¥æœŸ *</view>
          <picker mode="date" value="{{newPlan.planDate}}" bindchange="bindDateChange">
            <view class="picker-input">
              <text>{{newPlan.planDate || 'é€‰æ‹©æ—¥æœŸ'}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>
        
        <!-- æ—¶é—´é€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">è®¡åˆ’æ—¶é—´</view>
          <picker range="{{timeOptions}}" value="{{newPlan.planTime}}" bindchange="bindTimeChange">
            <view class="picker-input">
              <text>{{newPlan.planTime}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>
        
        <!-- ä¼˜å…ˆçº§é€‰æ‹© -->
        <view class="form-item">
          <view class="form-label">ä¼˜å…ˆçº§</view>
          <picker range="{{priorityOptions}}" range-key="label" bindchange="bindPriorityChange">
            <view class="picker-input">
              <text>{{newPlan.priority === 'high' ? 'é«˜ä¼˜å…ˆçº§' : newPlan.priority === 'low' ? 'ä½ä¼˜å…ˆçº§' : 'æ™®é€š'}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>
        
        <!-- å¤‡æ³¨ -->
        <view class="form-item">
          <view class="form-label">å¤‡æ³¨</view>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æ‹œè®¿å¤‡æ³¨" value="{{newPlan.remark}}" bindinput="onRemarkInput" maxlength="-1"></textarea>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="btn btn-cancel" bindtap="hideAddModal">å–æ¶ˆ</view>
        <view class="btn btn-confirm" bindtap="savePlan">ä¿å­˜</view>
      </view>
    </view>
  </view>

  <!-- å®¢æˆ·æœç´¢å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showSearchModal}}" bindtap="hideSearchModal">
    <view class="search-modal" catchtap="">
      <view class="search-modal-header">
        <text class="search-modal-title">é€‰æ‹©å®¢æˆ·</text>
        <view class="search-modal-close" bindtap="hideSearchModal">Ã—</view>
      </view>
      
      <view class="search-modal-body">
        <!-- æœç´¢æ¡† -->
        <view class="search-input-wrapper">
          <view class="search-icon-wrapper">ğŸ”</view>
          <input class="search-modal-input" placeholder="æœç´¢å®¢æˆ·åç§°ã€è”ç³»äººæˆ–ç”µè¯" value="{{searchCustomerKeyword}}" bindinput="onCustomerSearchInput" focus="{{showSearchModal}}" confirm-type="search" />
          <view class="search-clear-wrapper" wx:if="{{searchCustomerKeyword}}" bindtap="clearCustomerSearch">âœ•</view>
        </view>
        
        <!-- æ–°å»ºå®¢æˆ·æŒ‰é’® -->
        <view class="create-customer-btn" bindtap="createNewCustomer">
          <text class="create-icon">+</text>
          <text class="create-text">æ–°å»ºå®¢æˆ·</text>
        </view>
        
        <!-- å®¢æˆ·åˆ—è¡¨ -->
        <view class="customer-list">
          <view class="customer-item" wx:for="{{searchResults}}" wx:key="id" bindtap="selectCustomer" data-customer="{{item}}">
            <view class="customer-item-avatar">{{item.name.charAt(0)}}</view>
            <view class="customer-item-info">
              <view class="customer-item-name">{{item.name}}</view>
              <view class="customer-item-contact">{{item.contact}} {{item.phone}}</view>
              <view class="customer-item-address">{{item.address}}</view>
            </view>
          </view>
          
          <view class="no-results" wx:if="{{searchResults.length === 0 && searchCustomerKeyword}}">
            <text class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³å®¢æˆ·</text>
          </view>
          
          <view class="no-results" wx:if="{{searchResults.length === 0 && !searchCustomerKeyword}}">
            <text class="no-results-text">è¯·è¾“å…¥å…³é”®è¯æœç´¢å®¢æˆ·</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
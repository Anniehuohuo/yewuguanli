<!--pages/visit/checkin/checkin.wxml-->
<view class="container">
  <!-- å®¢æˆ·ä¿¡æ¯ -->
  <view class="card" wx:if="{{customer.id}}">
    <view class="card-header">
      <text>å®¢æˆ·ä¿¡æ¯</text>
    </view>
    <view class="card-body">
      <view class="info-item">
        <text class="info-label">å®¢æˆ·åç§°</text>
        <text class="info-value">{{customer.name}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">è”ç³»äºº</text>
        <text class="info-value">{{customer.contact || 'æ— '}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">åœ°å€</text>
        <text class="info-value">{{customer.address || 'æ— '}}</text>
      </view>
    </view>
  </view>
  
  <!-- é€‰æ‹©å®¢æˆ· -->
  <view class="card" wx:if="{{!customer.id}}">
    <view class="card-header">
      <text>é€‰æ‹©å®¢æˆ·</text>
    </view>
    <view class="card-body">
      <view class="customer-selector" bindtap="selectCustomer">
        <text class="placeholder">{{locationStatus === 'success' && nearbyCustomers.length > 0 ? 'é€‰æ‹©é™„è¿‘å®¢æˆ·' : 'è¯·é€‰æ‹©å®¢æˆ·'}}</text>
        <text class="selector-arrow">></text>
      </view>
      <view class="nearby-hint" wx:if="{{locationStatus === 'success' && nearbyCustomers.length > 0}}">
        <text>ğŸ“ å‘ç° {{nearbyCustomers.length}} ä¸ªé™„è¿‘å®¢æˆ·ï¼ˆ2å…¬é‡Œå†…ï¼‰</text>
      </view>
      <view class="nearby-hint" wx:if="{{locationStatus === 'success' && nearbyCustomers.length === 0}}">
        <text>ğŸ“ é™„è¿‘2å…¬é‡Œå†…æš‚æ— å®¢æˆ·ï¼Œç‚¹å‡»é€‰æ‹©å…¶ä»–å®¢æˆ·</text>
      </view>
    </view>
  </view>
  
  <!-- ä½ç½®ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <text>ä½ç½®ä¿¡æ¯</text>
      <text class="refresh-btn" bindtap="refreshLocation">åˆ·æ–°</text>
    </view>
    <view class="card-body">
      <view class="location-info">
        <view class="location-status {{locationStatus === 'success' ? 'success' : locationStatus === 'error' ? 'error' : ''}}">
          <text class="location-icon">ğŸ“</text>
          <text class="location-text">{{locationStatusText}}</text>
        </view>
        <view class="location-address" wx:if="{{locationStatus === 'success'}}">
          {{address}}
        </view>
      </view>
      <view class="map-container" wx:if="{{locationStatus === 'success'}}">
        <map id="locationMap" longitude="{{longitude}}" latitude="{{latitude}}" scale="16" markers="{{markers}}" show-location></map>
      </view>
    </view>
  </view>
  
  <!-- ç…§ç‰‡ä¸Šä¼  -->
  <view class="card">
    <view class="card-header">
      <text>æ‹ç…§è®°å½•</text>
    </view>
    <view class="card-body">
      <view class="upload-container">
        <view class="upload-item" wx:for="{{photos}}" wx:key="*this">
          <image src="{{item}}" mode="aspectFill"></image>
          <view class="upload-item-delete" catchtap="deletePhoto" data-index="{{index}}">Ã—</view>
        </view>
        <view class="upload-add" bindtap="takePhoto" wx:if="{{photos.length < 9}}">
          <text class="upload-add-icon">+</text>
          <text class="upload-add-text">æ‹ç…§</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- å¤‡æ³¨ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <text>å¤‡æ³¨ä¿¡æ¯</text>
    </view>
    <view class="card-body">
      <textarea class="form-textarea" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" bindinput="inputRemark" value="{{remark}}" maxlength="-1"></textarea>
    </view>
  </view>
  
  <!-- æäº¤æŒ‰é’® -->
  <view class="form-actions">
    <button class="btn btn-default" bindtap="cancelCheckin">å–æ¶ˆ</button>
    <button class="btn btn-primary" bindtap="submitCheckin" disabled="{{!canSubmit}}">æäº¤æ‰“å¡</button>
  </view>
</view>

<!-- å®¢æˆ·é€‰æ‹©å™¨å¼¹çª— -->
<view class="customer-selector-modal" wx:if="{{showCustomerSelector}}">
  <view class="modal-mask" bindtap="closeCustomerSelector"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é™„è¿‘å®¢æˆ·</text>
      <text class="modal-close" bindtap="closeCustomerSelector">Ã—</text>
    </view>
    <view class="modal-body">
       <view class="customer-list" wx:if="{{nearbyCustomers.length > 0}}">
         <view class="customer-item" wx:for="{{nearbyCustomers}}" wx:key="id" bindtap="selectNearbyCustomer" data-index="{{index}}">
           <view class="customer-info">
             <text class="customer-name">{{item.name}}</text>
             <text class="customer-address">{{item.address}}</text>
           </view>
           <view class="customer-distance">
             <text>{{item.distance}}km</text>
           </view>
         </view>
       </view>
       <view class="empty-customers" wx:else>
          <text class="empty-icon">ğŸ“</text>
          <text class="empty-text">é™„è¿‘2å…¬é‡Œå†…æš‚æ— å®¢æˆ·</text>
          <text class="empty-desc">è¯·ç‚¹å‡»å–æ¶ˆåé€‰æ‹©å…¶ä»–å®¢æˆ·</text>
        </view>
     </view>
    <view class="modal-footer">
       <button class="btn btn-default" bindtap="closeCustomerSelector">å–æ¶ˆ</button>
     </view>
  </view>
</view>